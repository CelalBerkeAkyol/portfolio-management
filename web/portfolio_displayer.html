<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portföy Karşılaştırma Aracı</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        background-color: #f8f9fa;
        color: #343a40;
        max-width: 1400px;
        margin: 20px auto;
        padding: 20px;
      }
      .container {
        background-color: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
      }
      h1,
      h2,
      h3 {
        text-align: center;
        color: #2c3e50;
      }
      h1 {
        font-size: 2.2em;
      }
      h2 {
        font-size: 1.8em;
        margin-top: 40px;
        border-bottom: 2px solid #f1f3f5;
        padding-bottom: 15px;
      }
      h3 {
        font-size: 1.4em;
        color: #34495e;
        margin-bottom: 20px;
        text-align: left;
      }

      .person-selector-container {
        margin-bottom: 30px;
        text-align: center;
      }
      .person-selector-container label {
        font-size: 1.2em;
        font-weight: 600;
        margin-right: 15px;
      }
      #person-selector {
        padding: 12px;
        font-size: 1.1em;
        border-radius: 8px;
        border: 1px solid #ced4da;
        min-width: 300px;
      }

      #results {
        margin-top: 40px;
        display: none;
      }
      .results-row {
        margin-bottom: 30px;
      }
      .card {
        background: #fff;
        padding: 25px;
        border-radius: 12px;
        border: 1px solid #e9ecef;
        height: 100%;
        box-sizing: border-box;
      }

      .charts-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }

      .us-sector-row {
        margin-top: 20px;
      }

      .details-grid {
        display: grid;
        grid-template-columns: 1.5fr 1fr;
        gap: 30px;
      }

      @media (max-width: 1200px) {
        .charts-container,
        .details-grid {
          grid-template-columns: 1fr;
        }
      }

      .chart-wrapper {
        position: relative;
        height: 400px;
      }

      #actions-table {
        width: 100%;
        border-collapse: collapse;
      }
      #actions-table th,
      #actions-table td {
        border: 1px solid #dee2e6;
        padding: 12px;
        text-align: right;
      }
      #actions-table th {
        background-color: #f1f3f5;
        font-weight: 600;
      }
      #actions-table td:first-child,
      #actions-table th:first-child {
        text-align: left;
        font-weight: 600;
      }
      #actions-table tbody tr:nth-child(even) {
        background-color: #f8f9fa;
      }
      .change-positive {
        color: #28a745;
        font-weight: 700;
      }
      .change-negative {
        color: #dc3545;
        font-weight: 700;
      }

      .scenario-card {
        padding: 20px;
        border-radius: 10px;
        border: 1px solid #e9ecef;
        margin-bottom: 15px;
      }
      .scenario-card:last-child {
        margin-bottom: 0;
      }
      .scenario-card h4 {
        margin-top: 0;
        margin-bottom: 15px;
        font-size: 1.1em;
        color: #495057;
        text-align: center;
      }
      .scenario-comparison {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        text-align: center;
      }
      .scenario-return {
        font-size: 1.7em;
        font-weight: 700;
        margin-bottom: 5px;
      }
      .return-positive {
        color: #28a745;
      }
      .return-negative {
        color: #dc3545;
      }
      .scenario-value {
        font-size: 1em;
        color: #6c757d;
        font-weight: 600;
      }
      .asset-label {
        font-size: 0.8em;
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Portföy Karşılaştırma Aracı</h1>

      <div class="person-selector-container">
        <label for="person-selector">Analiz Edilecek Kişiyi Seçin:</label>
        <select id="person-selector"></select>
      </div>

      <div id="results">
        <div class="results-row charts-container">
          <div class="card">
            <h3 style="text-align: center">Mevcut Portföy Dağılımı</h3>
            <div class="chart-wrapper">
              <canvas id="currentPieChart"></canvas>
            </div>
          </div>
          <div class="card">
            <h3 style="text-align: center">Hedef Portföy Dağılımı</h3>
            <div class="chart-wrapper">
              <canvas id="targetPieChart"></canvas>
            </div>
          </div>
        </div>

        <div class="results-row us-sector-row">
          <div class="card">
            <h3 style="text-align: center">
              ABD Sektör Dağılımı (Foreign Stocks)
            </h3>
            <div class="chart-wrapper">
              <canvas id="usSectorChart"></canvas>
            </div>
            <p
              id="us-sector-note"
              style="
                text-align: center;
                color: #6c757d;
                margin-top: 10px;
                display: none;
              "
            ></p>
          </div>
        </div>

        <div class="results-row details-grid">
          <div class="card">
            <h3>Portföy Dengeleme Aksiyonları</h3>
            <table id="actions-table">
              <thead>
                <tr>
                  <th>Varlık</th>
                  <th>Mevcut Tutar</th>
                  <th>Hedef Tutar</th>
                  <th>Aksiyon (Al / Sat)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="card" id="scenarios-card"></div>
        </div>
      </div>
    </div>

    <script>
      Chart.register(ChartDataLabels);

      let currentPieChart = null;
      let targetPieChart = null;
      let usSectorChart = null;
      let peopleData = [];
      let assetInfo = {};
      let sectorConfig = null;

      // Grafiğin ortasına yazı yazmak için özel eklenti
      const centerTextPlugin = {
        id: "centerTextPlugin",
        // DEĞİŞİKLİK: 'afterDraw' yerine 'beforeDraw' kullanıldı.
        beforeDraw: (chart) => {
          if (chart.options.plugins.centerTextPlugin.display) {
            const ctx = chart.ctx;
            const centerX = (chart.chartArea.left + chart.chartArea.right) / 2;
            const centerY = (chart.chartArea.top + chart.chartArea.bottom) / 2;
            const textLines =
              chart.options.plugins.centerTextPlugin.text.split("\n");

            ctx.save();

            // "Risk Skoru" başlığı
            ctx.font =
              '600 16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif';
            ctx.fillStyle = "#6c757d"; // Gri renk
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(textLines[0], centerX, centerY - 12);

            // Skorun kendisi
            ctx.font =
              'bold 32px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif';
            ctx.fillStyle = "#2c3e50"; // Koyu renk
            ctx.fillText(textLines[1], centerX, centerY + 15);

            ctx.restore();
          }
        },
      };

      function displayResults(data) {
        const fC = (num) =>
          num.toLocaleString("tr-TR", { style: "currency", currency: "TRY" });
        const fChange = (num) => {
          const sign = num > 0 ? "+" : "";
          return `${sign}${num.toLocaleString("tr-TR", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          })}`;
        };

        const resultsContainer = document.getElementById("results");

        let actionsHTML = "";
        data.allAssets.forEach((asset) => {
          const currentAmount = data.current.amounts[asset] || 0;
          const targetAmount = data.target.amounts[asset] || 0;
          const changeAmount = targetAmount - currentAmount;
          const currentPercent =
            data.current.principal > 0
              ? (currentAmount / data.current.principal) * 100
              : 0;
          const targetPercent =
            data.target.principal > 0
              ? (targetAmount / data.target.principal) * 100
              : 0;

          actionsHTML += `
              <tr>
                  <td>${asset}</td>
                  <td>${fC(currentAmount)} (${currentPercent.toFixed(2)}%)</td>
                  <td>${fC(targetAmount)} (${targetPercent.toFixed(2)}%)</td>
                  <td class="${
                    changeAmount >= 0 ? "change-positive" : "change-negative"
                  }">${fChange(changeAmount)} TL</td>
              </tr>
          `;
        });

        let scenariosHTML = "<h3>Senaryo Analizi Karşılaştırması</h3>";
        ["bad", "base", "good"].forEach((s) => {
          const scenarioName =
            s === "bad"
              ? "Kötü Senaryo"
              : s === "base"
              ? "Baz Senaryo"
              : "İyi Senaryo";
          const currentReturn = calculatePortfolioReturn(
            data.current.percents,
            assetInfo,
            s
          );
          const targetReturn = calculatePortfolioReturn(
            data.target.percents,
            assetInfo,
            s
          );

          scenariosHTML += `
              <div class="scenario-card">
                  <h4>${scenarioName}</h4>
                  <div class="scenario-comparison">
                      <div>
                          <span class="asset-label">Mevcut Portföy</span>
                          <div class="scenario-return ${
                            currentReturn >= 0
                              ? "return-positive"
                              : "return-negative"
                          }">%${(currentReturn * 100).toFixed(2)}</div>
                          <div class="scenario-value">${fC(
                            data.current.principal * (1 + currentReturn)
                          )}</div>
                      </div>
                      <div>
                          <span class="asset-label">Hedef Portföy</span>
                          <div class="scenario-return ${
                            targetReturn >= 0
                              ? "return-positive"
                              : "return-negative"
                          }">%${(targetReturn * 100).toFixed(2)}</div>
                          <div class="scenario-value">${fC(
                            data.target.principal * (1 + targetReturn)
                          )}</div>
                      </div>
                  </div>
              </div>
          `;
        });

        document.querySelector("#actions-table tbody").innerHTML = actionsHTML;
        document.getElementById("scenarios-card").innerHTML = scenariosHTML;

        drawPieChart(
          "currentPieChart",
          "Mevcut Dağılım",
          data.current.amounts,
          data.current.riskScore
        );
        drawPieChart(
          "targetPieChart",
          "Hedef Dağılım",
          data.target.amounts,
          data.target.riskScore
        );

        resultsContainer.style.display = "block";
      }

      const assetColorMap = {
        Gold: "#FFD700",
        Silver: "#C0C0C0",
        BTC: "#AC5531",
        Cryptocurrency: "#9B243F",
        "Foreign Stocks": "#419EC6",
        "Turkish Fund": "#3083A5",
        "Turkish Stocks": "#287695",
        "USD TRY Based": "#2B4A27",
        "TRY Based Interest": "#5B8569",
        "USD Based Interest": "#85AB80",
      };

      // String'den tutarlı renk üretme fonksiyonu
      function stringToColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
          hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }

        // HSL kullanarak daha dengeli renkler üret
        const hue = Math.abs(hash) % 360;
        const saturation = 60 + (Math.abs(hash >> 8) % 20); // 60-80 arası
        const lightness = 45 + (Math.abs(hash >> 16) % 15); // 45-60 arası

        return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
      }

      function getColorForAsset(assetName) {
        // Önce tanımlı renklerden kontrol et
        if (assetColorMap[assetName]) {
          return assetColorMap[assetName];
        }
        // Yoksa dinamik olarak üret
        return stringToColor(assetName);
      }

      function drawPieChart(canvasId, title, chartDataObj, riskScore) {
        const chartCanvas = document.getElementById(canvasId);
        if (!chartCanvas) return;

        if (canvasId === "currentPieChart" && currentPieChart)
          currentPieChart.destroy();
        if (canvasId === "targetPieChart" && targetPieChart)
          targetPieChart.destroy();
        if (canvasId === "usSectorChart" && usSectorChart)
          usSectorChart.destroy();

        const labels = Object.keys(chartDataObj).filter(
          (key) => chartDataObj[key] > 0
        );
        const data = labels.map((key) => chartDataObj[key]);
        const backgroundColors = labels.map((label) => getColorForAsset(label));
        const chart = new Chart(chartCanvas.getContext("2d"), {
          type: "doughnut",
          data: {
            labels: labels,
            datasets: [
              {
                label: title,
                data: data,
                backgroundColor: backgroundColors,
                borderColor: "#ffffff",
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: "bottom",
                labels: { padding: 20 },
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    const label = context.label || "";
                    const currentValue = context.raw || 0;
                    const total = context.dataset.data.reduce(
                      (a, b) => a + b,
                      0
                    );
                    const percentage =
                      total > 0 ? (currentValue / total) * 100 : 0;
                    const formattedValue = currentValue.toLocaleString(
                      "tr-TR",
                      { style: "currency", currency: "TRY" }
                    );
                    return `${label}: ${formattedValue} (${percentage.toFixed(
                      0
                    )}%)`;
                  },
                },
              },
              datalabels: {
                formatter: (value, context) => {
                  const total = context.chart.data.datasets[0].data.reduce(
                    (a, b) => a + b,
                    0
                  );
                  const percentage = (value / total) * 100;
                  if (percentage < 5) {
                    return "";
                  }
                  return `${percentage.toFixed(2)}%`;
                },
                color: "#fff",
                font: {
                  weight: "bold",
                  size: 14,
                },
              },
              centerTextPlugin:
                riskScore !== undefined
                  ? {
                      display: true,
                      text: `Risk Skoru\n${riskScore.toFixed(2)}`,
                    }
                  : { display: false },
            },
            cutout: "60%",
          },
          plugins: [centerTextPlugin],
        });

        if (canvasId === "currentPieChart") currentPieChart = chart;
        if (canvasId === "targetPieChart") targetPieChart = chart;
        if (canvasId === "usSectorChart") usSectorChart = chart;
      }

      document.addEventListener("DOMContentLoaded", async function () {
        try {
          const [peopleResponse, assetResponse, sectorResponse] =
            await Promise.all([
              fetch("../data/people.json"),
              fetch("../data/asset_info.json"),
              fetch("../data/us_sector_config.json"),
            ]);
          if (!peopleResponse.ok || !assetResponse.ok || !sectorResponse.ok) {
            throw new Error("JSON dosyaları yüklenirken bir ağ hatası oluştu.");
          }
          peopleData = await peopleResponse.json();
          assetInfo = await assetResponse.json();
          sectorConfig = await sectorResponse.json();
          initializeApp();
        } catch (error) {
          console.error("Veri yükleme hatası:", error);
          document.querySelector(
            ".container"
          ).innerHTML = `<h1>Hata: Veri dosyaları yüklenemedi.</h1><p>Lütfen 'people.json', 'asset_info.json' ve 'us_sector_config.json' dosyalarının HTML dosyasıyla aynı dizinde olduğundan emin olun.</p>`;
        }
      });
      function initializeApp() {
        populatePersonSelector();
        const personSelector = document.getElementById("person-selector");
        personSelector.addEventListener("change", function () {
          calculateAndDisplay(this.value);
        });
        calculateAndDisplay(0);
      }
      function populatePersonSelector() {
        const personSelector = document.getElementById("person-selector");
        personSelector.innerHTML = "";
        peopleData.forEach((person, index) => {
          const option = document.createElement("option");
          option.value = index;
          option.textContent = person.name;
          personSelector.appendChild(option);
        });
      }

      function calculateAndDisplay(personIndex) {
        const person = peopleData[personIndex];
        if (!person) return;

        const currentAmountDist = person.current_portfolio_amount || {};
        const targetPortfolioDef = person.target_portfolio || {};

        const overallPrincipal = Object.values(currentAmountDist).reduce(
          (a, b) => a + b,
          0
        );
        if (overallPrincipal === 0) {
          document.getElementById("results").style.display = "none";
          return;
        }

        const targetRiskScore = calculatePortfolioRisk(
          targetPortfolioDef,
          assetInfo
        );

        const currentPercentDist = {};
        for (const [asset, amount] of Object.entries(currentAmountDist)) {
          currentPercentDist[asset] = amount / overallPrincipal;
        }
        const targetAmountDist = {};
        for (const [asset, percent] of Object.entries(targetPortfolioDef)) {
          targetAmountDist[asset] = overallPrincipal * percent;
        }

        // ABD sektör dağılımı (Foreign Stocks hedef oranı kullanılarak)
        const foreignStocksPercent = targetPortfolioDef["Foreign Stocks"] || 0;
        const usTotalAmount = overallPrincipal * foreignStocksPercent;
        const sectorNote = document.getElementById("us-sector-note");
        if (usTotalAmount > 0 && sectorConfig?.sectors) {
          const sectorData = {};
          Object.entries(sectorConfig.sectors).forEach(([name, info]) => {
            sectorData[name] = usTotalAmount * (info.percentage || 0);
          });
          drawPieChart("usSectorChart", "ABD Sektör Dağılımı", sectorData);
          sectorNote.style.display = "block";
          sectorNote.textContent = `Foreign Stocks hedef oranı (%${(
            foreignStocksPercent * 100
          ).toFixed(0)}) x Toplam Portföy = ${usTotalAmount.toLocaleString(
            "tr-TR",
            { style: "currency", currency: "TRY" }
          )}`;
        } else {
          const canvas = document.getElementById("usSectorChart");
          if (canvas) {
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
          }
          if (usSectorChart) usSectorChart.destroy();
          sectorNote.style.display = "block";
          sectorNote.textContent =
            "Foreign Stocks oranı 0 olduğu için sektör dağılımı gösterilmiyor.";
        }

        const resultsData = {
          personName: person.name,
          allAssets: [
            ...new Set([
              ...Object.keys(currentAmountDist),
              ...Object.keys(targetPortfolioDef),
            ]),
          ].sort(
            (a, b) => (currentAmountDist[b] || 0) - (currentAmountDist[a] || 0)
          ),
          current: {
            principal: overallPrincipal,
            amounts: currentAmountDist,
            percents: currentPercentDist,
            riskScore: calculatePortfolioRisk(currentPercentDist, assetInfo),
          },
          target: {
            principal: overallPrincipal,
            amounts: targetAmountDist,
            percents: targetPortfolioDef,
            riskScore: targetRiskScore,
          },
        };
        displayResults(resultsData);
      }

      function calculatePortfolioRisk(portfolioDistribution, asset_info) {
        let totalRiskScore = 0;
        if (!portfolioDistribution) return 0;
        for (const [asset, percent] of Object.entries(portfolioDistribution)) {
          if (asset_info[asset]) {
            totalRiskScore += percent * (asset_info[asset].risk_score || 0);
          }
        }
        return totalRiskScore;
      }
      function calculatePortfolioReturn(
        portfolioDistribution,
        assetInfo,
        scenario = "base"
      ) {
        if (!portfolioDistribution) return 0;
        const scenario_keys = {
          base: "expected_percentage_return",
          good: "good_scenario_return",
          bad: "bad_scenario_return",
        };
        const key = scenario_keys[scenario];
        let totalReturnPercent = 0;
        const usd_try_return_expectation =
          assetInfo["USD TRY Based"]?.[key] || 0;
        for (const [asset, percent] of Object.entries(portfolioDistribution)) {
          if (assetInfo[asset]) {
            if (asset === "USD TRY Based") {
              totalReturnPercent += percent * usd_try_return_expectation;
              continue;
            }
            let assetReturn = assetInfo[asset][key] || 0;
            if (assetInfo[asset].is_usd_based) {
              assetReturn =
                (1 + assetReturn) * (1 + usd_try_return_expectation) - 1;
            }
            totalReturnPercent += percent * assetReturn;
          }
        }
        return totalReturnPercent;
      }
    </script>
  </body>
</html>
